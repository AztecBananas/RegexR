<!DOCTYPE html>
  <head>

    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>

    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">

  </head>
  <body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <ul class="nav navbar-nav">
        <li><a href="#">Title</a>
        <li><a href="#">Login</a>
        <li><a href="#">Scoreboard</a>
      </ul>
    </div>
  </nav>
  <div class="container">
    <div id="game"></div>
  </div>
  
  <script type="text/jsx">
  var dispatcher = {
    _subs: [],
    register: function(cb){
      this._subs.push(cb);
    },

    dispatch: function(payload){
      for(var i = 0; i < this._subs.length; i++){
        this._subs[i](payload);
      }
    }
  };

  var GameBox = React.createClass({
    getInitialState: function(){
      return {questions: []}
    },
    changeView: function(question){
      this.setState({questions: [question]});
    },
    componentDidMount: function(){
      dispatcher.register(function(payload){
        if(payload.action === "StateChange"){
          this.setState({questions: payload.questions});
        }
      }.bind(this));
      $.ajax({
        url: 'http://localhost:3000/questions',
        method: 'GET',
        dataType: 'json',
        success: function(data){
          data.sort(function(a, b){
            return a.qNumber - b.qNumber;
          });
          this.setState({questions: data});

        }.bind(this),
        error: function(xhr, status, err){
          console.error(xhr, status, err.message);
        }.bind(this)
      });
    },
    render: function() {
      return (
        <div className="gameBox">
          <h2 className="title">Regex Game</h2>
          <QuestionContainer data={this.state.questions} />
        </div>
      );
    }
  });

  var QuestionContainer = React.createClass({
    submit: function(e){
      e.preventDefault();
      console.log(this);
      var iFlag = React.findDOMNode(this.refs.iFlag).value;
      var answer = React.findDOMNode(this.refs.solutionText).value;
      console.log("Submitted");
      $.ajax({
        url: 'http://localhost:3000/questions/' + this.props.data[0]._id,
        method: "POST",
        data: {
          regexString: answer,
          iFlag: iFlag,
        },
        success: function(data){
          console.log(data);
          React.findDOMNode(this.refs.message).value = data.message;
          React.findDOMNode(this.refs.iFlag).value = '';
          React.findDOMNode(this.refs.solutionText).value = '';
        }.bind(this),
        error: function(xhr, status, err){
          console.log(xhr, status, err.message);
        }.bind(this)
      });
    },
    render: function() {
      if(this.props.data.length === 1){
        return (
          <div className="question-solve">
            <h2>{this.props.data[0].title}</h2>
            <p>{this.props.data[0].description}</p>
            <p ref="message"></p>
            <form name="questionSolution" >
              <div className="form-group">
                <label for="iFlag">iFlag</label>
                <input placeholder="iFlag" className=".form-control" type="text" id="iFlag" ref="iFlag" />
              </div>
              <div className="form-group">
                <label for="solution">Solution Regex</label>
                <textarea placeholder="Regex solution..." classsName=".form-control" id="solution" ref="solutionText"></textarea>
              </div>
              <button onClick={this.submit} className="btn btn-primary" name="solutionButton">Check Answer!</button>
            </form>
          </div>
        );
      } else {
        var questions = this.props.data.map(function(question) {
          return (
            <tr className="question">
              <td><b>{question.title}</b></td>
              <td><p>{question.description}</p></td>
              <td><a className="btn btn-primary" onClick={function() {dispatcher.dispatch({action: "StateChange", questions: [question]})}} href="#" >Solve</a></td>
            </tr>
          )
        });
      }

      return (
        <table className="questionContainer table table-hover">
          <tbody>
            {questions}
          </tbody>
        </table>
      )
    }
  })

  React.render(
    <GameBox />, 
    document.getElementById('game')
  );
  </script>


  </body>
</html>
